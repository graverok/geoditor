!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).geoditor={})}(this,function(e){"use strict";class t{constructor(e){this._locked=!1,this.layerNames=e}}const i='<rect x="0" y="0" width="32" height="32" opacity="0"/>',s='<circle cx="8.5" cy="10.5" r="1"/><circle cx="8.5" cy="21.5" r="1"/><circle cx="19" cy="21.5" r="1"/><circle cx="24" cy="10.5" r="1"/><path d="M8.5 11.5V20.5"/><path d="M9.5 21.5H18"/><path d="M23.5794 11.4265L19.41 20.5991"/><path d="M23 10.5H9.5"/>',r='<circle cx="8.5" cy="21.5" r="1"/><circle cx="11.5" cy="11.5" r="1"/><circle cx="23.5" cy="11.5" r="1"/><path d="M11.2208 12.4307L8.8 20.5"/>',n=r+'<path d="M12.5 11.5H22.5"/>';r;var a='<circle cx="16" cy="16" r="7.5" /><path d="M10.6953 21.3047L21.3203 10.6797"/>',o='<rect x="20.5" y="20.5" width="8" height="8" rx="1.5" />',l='<circle cx="24.5" cy="24.5" r="2.5" stroke-width="1.2"/>';var h=(e,t=1,s="32 32")=>`<g transform="scale(0.5 0.5) translate(${s})" stroke-width="${2*t}">${i}${e}</g>`;const V={default:void 0,plus:['<g stroke="#FFF"><g stroke-linecap="round" fill="none" stroke-width="1"><path d="M24.5 22V27" /><path d="M22 24.5H27" /></g></g>',`<g stroke-width="1">${i}${o}</g>`],minus:['<g stroke="#FFF"><g stroke-linecap="square" fill="none"><path d="M22 24.5H27" /></g></g>',`<g stroke-width="1">${i}${o}</g>`],disabled:[`<g fill="none" stroke="#FFF">${h(a)}</g>`,`<g fill="#EB2F12" stroke="#EB2F12">${h(a,3)}</g>`],extend:[h('<circle cx="8.5" cy="21.5" r="1"/><circle cx="11.5" cy="11.5" r="1"/><circle cx="23.5" cy="11.5" r="1"/><path d="M11.2208 12.4307L8.8 20.5"/><path d="M12.5 11.5H22.5" stroke-dasharray="2 2"/>'),`<g fill="#FFF" stroke="#FFF">${h(n,3)}</g>`],line:[h(n),`<g fill="#FFF" stroke="#FFF">${h(n,3)}</g>`],polygon:[h(s,1,"34 32"),`<g fill="#FFF" stroke="#FFF">${h(s,3,"34 32")}</g>`],point:[`<g fill="none" stroke="#FFF">${l}</g>`,`<g fill="#000" stroke="#000">${i}${l}</g>`]},c=e=>{switch(e){case"alt":return"altKey";case"shift":return"shiftKey";case"ctrl":return"ctrlKey";case"meta":return"metaKey"}},g=(e,t)=>{var s;if(!e)return[];if(e.nesting[0]!==t[0])return[];switch(e.type){case"LineString":return 1<t.length&&0<t[1]?[]:Array.from(e.coordinates);case"MultiLineString":case"Polygon":return t.length<1?[]:2<t.length&&0<t[1]?[]:Array.from(null!=(s=e.coordinates[t[1]])?s:[]);case"MultiPolygon":return t.length<2?[]:Array.from(null!=(s=null==(s=e.coordinates[t[1]])?void 0:s[t[2]])?s:[]);default:return[]}},_=(i,r)=>{switch(i.type){case"LineString":return{...i,coordinates:r(i.coordinates,[...i.nesting])||i.coordinates};case"Polygon":case"MultiLineString":return{...i,coordinates:i.coordinates.map((e,t)=>r(e,[...i.nesting,t])||e)};case"MultiPolygon":return{...i,coordinates:i.coordinates.map((e,s)=>e.map((e,t)=>r(e,[...i.nesting,s,t])||e))};default:return i}},u=(e,t,s,i=["LineString","MultiLineString","Polygon","MultiPolygon"])=>{var r;if(e){if(e.nesting[0]!==t[0])return e;var n=t.slice(1),a=e=>{return s?"function"==typeof s?null!=(e=s(e||[]))&&e.length?[e]:[]:null!=s&&s.length?[s]:[]:[]},o=(e,t)=>{if(0!==t.length)return 1===t.length&&i.includes("LineString")?{...e,type:"LineString",coordinates:t[0]}:{...e,type:"MultiLineString",coordinates:t}},l=(e,t)=>{t=t.filter(e=>e.length);if(0!==t.length)return 1===t.length&&i.includes("Polygon")?{...e,type:"Polygon",coordinates:t[0]}:{...e,type:"MultiPolygon",coordinates:t}};switch(e.type){case"LineString":return o(e,n.length?[...null!=(r=e.coordinates)&&r.length?[e.coordinates].slice(0,n[0]):[],...a()]:a(e.coordinates));case"MultiLineString":return o(e,n.length?[...(e.coordinates||[]).slice(0,n[0]),...a(e.coordinates[n[0]]),...(e.coordinates||[]).slice(n[0]+1)]:a());case"Polygon":return l(e,1<n.length?[...[[...e.coordinates||[]]].slice(0,n[0]),a()]:n.length?[[...(e.coordinates||[]).slice(0,n[0]),...a(null==(r=e.coordinates)?void 0:r[n[0]]),...(e.coordinates||[]).slice(n[0]+1)]]:[a()]);case"MultiPolygon":return l(e,1<n.length?[...(null!=(r=e.coordinates)?r:[]).slice(0,n[0]),[...(null!=(r=null==(r=e.coordinates)?void 0:r[n[0]])?r:[]).slice(0,n[1]),...a(null==(r=null==(r=e.coordinates)?void 0:r[n[0]])?void 0:r[n[1]]),...(null!=(r=null==(r=e.coordinates)?void 0:r[n[0]])?r:[]).slice(n[1]+1)],...(null!=(r=e.coordinates)?r:[]).slice(n[0]+1)]:n.length?[...(null!=(r=e.coordinates)?r:[]).slice(0,n[0]),a(),...(null!=(r=e.coordinates)?r:[]).slice(n[0]+1)]:[a()]);default:return e}}},v=(e,t)=>t?t.reduce((i,t)=>{const r=e.find(e=>(Array.isArray(t)?t[0]:t)===e.nesting[0]);return r&&_(r,(e,s)=>{Array.isArray(t)&&!k.equal(s.slice(0,t.length),t)||y(e,r.type).forEach((e,t)=>{i.push({type:"Point",coordinates:e,nesting:[...s,t],props:r.props})})}),i},[]):e.reduce((i,r)=>(_(r,(e,s)=>{y(e,r.type).forEach((e,t)=>{i.push({type:"Point",coordinates:e,nesting:[...s,t],props:r.props})})}),i),[]),m=(e,t)=>{switch(t){case"Polygon":case"MultiPolygon":return[...e,e[0]];default:return e}},y=(e,t)=>{switch(t){case"Polygon":case"MultiPolygon":return e.slice(0,e.length-1);default:return e}},b=e=>"Polygon"===e.type||"MultiPolygon"===e.type,d=e=>e/180*Math.PI,p=e=>e/Math.PI*180,f={rad:d,degree:p,cos:e=>Math.cos(d(e)),sin:e=>Math.sin(d(e)),delta:(e,t)=>{e=Math.pow(f.sin((t[1]-e[1])/2),2)+Math.pow(f.sin((t[0]-e[0])/2),2)*f.cos(e[1])*f.cos(t[1]);return 2*Math.atan2(Math.sqrt(e),Math.sqrt(1-e))},bearing:(e,t)=>p(Math.atan2(f.sin(t[0]-e[0])*f.cos(t[1]),f.cos(e[1])*f.sin(t[1])-f.sin(e[1])*f.cos(t[1])*f.cos(t[0]-e[0])))},L={move:(e,t,s)=>[e[0]+s[0]-t[0],e[1]+s[1]-t[1]],middle:(e,t)=>e&&t?[e[0]/2+t[0]/2,e[1]/2+t[1]/2]:e||t,closest:(e,t)=>e&&t?f.delta(e,t):-1,normalize:e=>{let[t,s]=e;return[t,s=(s=90<s?180-s:s)<-90?-180-s:s]}},H={move:(e,t,s)=>e.map(e=>L.normalize([s[0]-(t[0]-e[0])*Math.cos(f.rad(e[1]))/Math.cos(f.rad(e[1]+s[1]-t[1])),e[1]+s[1]-t[1]]))},k={equal:(s,i,r=!1)=>"object"!=typeof s||"object"!=typeof i?s===i:!(s.length!==i.length&&!r||(r&&s.length>i.length?i.some((e,t)=>!k.equal(e,s[t],r)):s.some((e,t)=>!k.equal(e,i[t],r)))),intersect:(e,t)=>e.some(e=>t.includes(e)),plain:e=>Array.isArray(e)?k.plain(e[0]):e,array:e=>Array.isArray(e)?e:[e]},w=(e,t,s="currentColor")=>`<svg width="${t}" height="${t}" viewBox="0 0 ${t} ${t}" fill="${s}" stroke="${s}" xmlns="http://www.w3.org/2000/svg">${e}</svg>`,F=(e,t,s,i="black",r)=>{s=V[s],s=w(`<filter id="dropshadow" height="200%" width="200%"><feGaussianBlur in="SourceAlpha" stdDeviation="1"/><feOffset dx="0.4" dy="0.8" result="offsetblur"/><feComponentTransfer><feFuncA type="linear" slope="0.3"/></feComponentTransfer><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter><g stroke-width="1.2"><g stroke-width="1.1" style="filter:url(#dropshadow)">${t}</g>${e}</g>`+(s?`<g stroke-width="1">${t=`<g stroke-width="0.9" style="filter:url(#dropshadow)">${s[1]}</g>`+s[0],e=r,e?`<g transform="translate(${e})">${t}</g>`:t}</g>`:""),32,i);return"data:image/svg+xml;base64,"+btoa(s)};class M{constructor(e){this._state={active:[],disabled:[],hover:[]},this._callback=e}set(s,i){var e=i.reduce((e,t)=>this._state[s].some(e=>k.equal(t,e))?e:[...e,k.array(t)],[]),t=this._state[s].reduce((e,t)=>i.some(e=>k.equal(t,e))?e:[...e,k.array(t)],[]);this._state[s]=i,this._callback(s,e,t)}get(t){return"string"==typeof t?this._state[t]:["active","hover","disabled"].filter(e=>this._state[e].find(e=>k.equal(e,t)))}add(e,t){t=t.filter(t=>!this._state[e].some(e=>k.equal(t,e)));this._state[e]=[...this._state[e],...t],this._callback(e,t.map(e=>k.array(e)),[])}remove(e,s){const i=this._state[e].filter(t=>s.some(e=>k.equal(t,e)||k.equal(k.plain(t),e)));this._state[e]=this._state[e].filter(t=>!i.some(e=>k.equal(t,e))),this._callback(e,[],i.map(e=>k.array(e)))}refresh(e){this._callback(e,this._state[e].map(e=>k.array(e)),[])}}class K{constructor(e,t){this._controller=e,this._emitters=t,this._data=[],this.addListener=this._controller.addListener,this.removeListener=this._controller.removeListener,this.setCursor=this._controller.setCursor,this.state={features:new M((e,t,s)=>{s.length&&(this._controller.setState("lines",s,e,!1),this._controller.setState("planes",s,e,!1)),t.length&&(this._controller.setState("lines",t,e,!0),this._controller.setState("planes",t,e,!0)),"active"===e&&null!=(t=(s=this._emitters).select)&&t.call(s,this.state.features.get("active"))}),points:new M((e,t,s)=>{s.length&&this._controller.setState("points",s,e,!1),t.length&&this._controller.setState("points",t,e,!0)})}}getFeatures(e){const t=e.map(k.plain);return this.features.filter(e=>t.includes(e.nesting[0]))}init(){this.render("features",this.features)}reset(){this.state.features.set("active",[]),this.state.features.set("disabled",[]),this.render("features",this.features),this.render("points",[])}isolate(s){var e=s&&!s.some(e=>"number"==typeof e)||this.state.features.get("active").length&&!this.state.features.get("active").some(e=>"number"==typeof e)?this.features.reduce((e,t)=>(s||this.state.features.get("active")).map(k.plain).includes(t.nesting[0])?e:[...e,t.nesting[0]],[]):[];this.state.features.remove("active",e),this.state.features.set("disabled",e)}get features(){return this._data.map((e,t)=>({nesting:[t],type:e.geometry.type,coordinates:"GeometryCollection"!==e.geometry.type?e.geometry.coordinates:[],props:e.properties}))}set features(e){var t=O(e,this.state.features.get("active"));this._data=this.mapper(e),this.render("features",this.features),this.state.features.set("active",t),null!=(t=(e=this._emitters).change)&&t.call(e)}get data(){return this._data}set data(e){var t=this._data.length===e.length;this._data=e,this.render("features",this.features),t?this.state.features.refresh("active"):(this.state.features.set("active",[]),this.state.features.set("disabled",[]))}get renderer(){return this._controller.renderer}render(e,t){var s,i;"features"===e&&null!=(i=(s=this._emitters).render)&&i.call(s,this.mapper(t)),this._controller.render(e,t)}remove(){this._controller.remove()}mapper(e){return e.map(e=>this._data[e.nesting[0]]?{...this.data[e.nesting[0]],geometry:{type:e.type,coordinates:e.coordinates},properties:e.props}:{type:"Feature",geometry:{type:e.type,coordinates:e.coordinates},properties:e.props})}}const O=(r,e)=>e.reduce((e,i)=>{var t=r.find(e=>e.nesting[0]===k.plain(i));if(!t)return e=0===(e=e.filter(e=>k.plain(i)!==k.plain(e))).length&&r.length?[Math.min(k.plain(i),r.length-1)]:e;if("number"==typeof i)return e;const s=[];return _(t,(e,t)=>{t.forEach((e,t)=>{s[t]="number"==typeof s[t]?Math.max(s[t],e):e})}),[...e.filter(e=>!k.equal(e,i)),s.reduce((e,t,s)=>"number"==typeof i[s]?[...e,Math.min(t,i[s])]:e,[])]},e);class S{constructor(e){this.disabled=!0,this.config=e,this.off=this.off.bind(this)}init(e){this.core=e}on(e,...t){return null!=e&&e.off(this),this.start(...t),!0}off(e){e!==this&&this.finish()}start(){this.enable()}finish(){this.disable()}get icon(){return""}enable(){this.disabled=!1}disable(){this.disabled=!0}}class C extends S{constructor(e){var t;super({modify:null==(t=null==e?void 0:e.modify)||t,filter:null!=(t=null==e?void 0:e.filter)?t:()=>!0}),this._state={dragging:!1,modifiers:[]},this._stored={},this._event=null,this._paused=!1,this.cursor=(e,t)=>`url(${F(`<g fill="none" stroke="#FFF">${P}</g>`,`<g fill="#000" stroke="#000">${P}</g>`,e,"#000","-2.5 0")}) 10 8, `+t,this._canvasclick=this._canvasclick.bind(this),this._canvasleave=this._canvasleave.bind(this),this._featurehover=this._featurehover.bind(this),this._shapedrag=this._shapedrag.bind(this),this._shapedblclick=this._shapedblclick.bind(this),this._pointhover=this._pointhover.bind(this),this._pointdrag=this._pointdrag.bind(this),this._keypress=this._keypress.bind(this)}get icon(){return`<g fill="none" transform="translate(-4 -4)">${P}</g>`}refresh(){var e;this.core.render("features",null!=(e=this._state.features)?e:this.core.features),this.core.isolate(),this._render()}enable(){this._paused=!1,this.disabled&&(super.enable(),this._stored.cursor=this.core.setCursor("default"),this.core.addListener("mouseout",this._canvasleave),this.core.addListener("mouseenter","points",this._pointhover),this.core.addListener("mousemove",this._featurehover),this.core.addListener("click",this._canvasclick),this.core.addListener("mousedown","points",this._pointdrag),this.core.addListener("mousedown","lines",this._shapedrag),this.core.addListener("mousedown","planes",this._shapedrag),this.core.addListener("dblclick","lines",this._shapedblclick),this.core.addListener("dblclick","planes",this._shapedblclick),document.addEventListener("keydown",this._keypress),document.addEventListener("keyup",this._keypress))}disable(){var e,t;this._state.dragging?this._paused=!0:(this._paused=!1,this.disabled||(super.disable(),null!=(t=(e=this._stored).cursor)&&t.call(e),document.removeEventListener("keydown",this._keypress),document.removeEventListener("keyup",this._keypress),this.core.removeListener("mousedown","points",this._pointdrag),this.core.removeListener("mouseenter","points",this._pointhover),this.core.removeListener("mousedown","planes",this._shapedrag),this.core.removeListener("mousedown","lines",this._shapedrag),this.core.removeListener("dblclick","planes",this._shapedblclick),this.core.removeListener("dblclick","lines",this._shapedblclick),this.core.removeListener("click",this._canvasclick),this.core.removeListener("mousemove",this._featurehover),this.core.removeListener("mouseout",this._canvasleave)))}start(){super.start(),this.core.isolate(),this._state.features&&this.core.render("features",this._state.features),this._render()}finish(){this._state.features&&(this.core.features=this._state.features),this._state={dragging:!1,modifiers:[]},super.finish()}_canvasleave(){this.core.state.features.set("hover",[])}_featurehover(t){if(!this._state.dragging){var s=(this._event=t).points.filter(this.config.filter),i=t.lines.filter(this.config.filter),t=t.planes.filter(this.config.filter);let e=[...s,...i,...t].map(e=>e.nesting);this.core.state.features.get("active").every(e=>"number"==typeof e)?(this.core.setCursor(e.length?this.cursor("default","pointer"):"default"),this.core.state.features.set("hover",e.length?[k.plain(e[0])]:[])):(e=e.filter(e=>this.core.state.features.get("active").map(k.plain).includes(k.plain(e)))).length?(this.core.setCursor(this.cursor(s.length?"point":i.length?"line":"polygon","pointer")),this.core.state.features.set("hover",e.length?[e[0]]:[])):(this.core.setCursor("default"),this.core.state.features.set("hover",[]))}}_canvasclick(e){e.preventDefault();var t=[...e.points,...e.lines,...e.planes].map(e=>e.nesting[0]);if("string"!=typeof this.config.modify||!["meta","alt","ctrl"].includes(this.config.modify)||!e.originalEvent[c(this.config.modify)]){if(this.core.state.features.get("active").some(e=>"number"==typeof e)){if(t.length)return}else if(k.intersect(this.core.state.features.get("active").map(k.plain),t))return;this.core.state.features.set("active",[]),this.core.isolate(),this._render(),this._featurehover(e)}}_shapedrag(r){if((!r.points.filter(this.config.filter).length||this.core.state.features.get("active").some(e=>"number"==typeof e))&&("planes"!==r.layer||!r.lines.filter(this.config.filter).length)){var e=r[r.layer][0];if(e){r.preventDefault();const t={active:this.core.state.features.get("active"),hover:this.core.state.features.get("hover")},s=T(r.originalEvent.shiftKey,this.core.state.features.get("active"),e.nesting,!0===this.config.modify);if(s){this.core.state.features.set("active",s.active),this._render(),this._state.dragging=!0;const i=i=>{!this._state.features&&Math.abs(i.originalEvent.pageX-r.originalEvent.pageX)<=3&&Math.abs(i.originalEvent.pageY-r.originalEvent.pageY)<=3||(this._state.features=this.core.features.map(t=>{const s=this.core.state.features.get("active").filter(e=>k.plain(e)===t.nesting[0]);return s.length?_(t,(e,t)=>s.some(e=>"number"==typeof e||k.equal(e,t.slice(0,e.length)))?H.move(e,r.position,i.position):e):t}),this.core.render("features",this._state.features),this.core.render("points",v(this._state.features,this.core.state.features.get("active")).filter(this.config.filter)))};this.core.addListener("mousemove",i),document.addEventListener("mouseup",()=>{var e;this.core.removeListener("mousemove",i),this._state.dragging=!1,this._state.features?(this.core.state.features.set("hover",t.hover),this._state.features&&(this.core.features=this._state.features),this._state.features=void 0):((e=null==(e=s.release)?void 0:e.call(s))&&(this.core.state.features.set("hover",e),this.core.state.features.set("active",e)),this.refresh()),this._featurehover(r),this._paused&&this.disable()},{once:!0})}}}}_shapedblclick(e){e.preventDefault(),"dblclick"!==this.config.modify||e.points.filter(this.config.filter).length&&!this.core.state.features.get("active").some(e=>"number"==typeof e)||"planes"===e.layer&&e.lines.filter(this.config.filter).length||(e=e[e.layer][0])&&(this.core.state.features.set("active",[[e.nesting[0]]]),this.refresh())}_keypress(e){"string"==typeof this.config.modify&&["meta","alt","ctrl"].includes(this.config.modify)&&(e[c(this.config.modify)]?(this.core.state.features.set("active",this.core.state.features.get("active").map(k.array)),this.refresh(),this._event&&this._featurehover(this._event)):this._state.dragging||(this.core.state.features.set("active",this.core.state.features.get("active").map(k.plain)),this.core.state.points.set("active",[]),this.core.state.points.set("hover",[]),this.refresh(),this._event&&this._featurehover(this._event)))}_pointhover(e){if(!this.core.state.features.get("active").some(e=>"number"==typeof e)){let s=e.points.filter(this.config.filter)[0];if(s){this._state.dragging||this.core.state.points.set("hover",[s.nesting]);const t=e=>{var t;this._state.dragging||k.equal(null!=(t=e.points[0].nesting)?t:[],s.nesting)||(s=e.points.filter(this.config.filter)[0],this.core.state.points.set("hover",[s.nesting]))},i=()=>{this._state.dragging||this.core.state.points.set("hover",[]),this.core.removeListener("mouseleave","points",i),this.core.removeListener("mousemove","points",t)};this.core.addListener("mouseleave","points",i),this.core.addListener("mousemove","points",t)}}}_pointdrag(t){if(this.core.state.features.get("active").some(e=>"number"==typeof e))return;const r=t.points.filter(this.config.filter)[0];let s=this.core.getFeatures([null===r||void 0===r?void 0:r.nesting[0]])[0];if(!r||!s)return;t.preventDefault();let i;this._state.dragging=!0;const n=r.nesting.length-1;let a=y(g(s,r.nesting.slice(0,n)),s.type);const o=(s,i)=>_(s,(e,t)=>k.equal(r.nesting.slice(0,t.length),t)?m([...a.slice(0,r.nesting[n]),...i?[i]:[],...a.slice(r.nesting[n]+1)],null==s?void 0:s.type):e),l=(r.nesting[n]>=a.length&&(r.nesting[n]=r.nesting[n]%a.length+1,a=[...a.slice(0,r.nesting[n]),r.coordinates,...a.slice(r.nesting[n])],s=_(s,(e,t)=>k.equal(r.nesting.slice(0,t.length),t)?m(a,null===s||void 0===s?void 0:s.type):e),this._state.features=[...this.core.features.slice(0,r.nesting[0]),s,...this.core.features.slice(r.nesting[0]+1)]),e=>{i=e.points.find(e=>!this.core.state.points.get(e.nesting).includes("disabled")&&!k.equal(e.nesting,r.nesting))}),h=()=>{i=void 0},c=e=>{s=o(s,L.normalize((null===i||void 0===i?void 0:i.coordinates)||L.move(r.coordinates,t.position,e.position))),this._state.features=[...this.core.features.slice(0,r.nesting[0]),s,...this.core.features.slice(r.nesting[0]+1)],this.core.render("features",this._state.features),this.core.render("points",v([s],this.core.state.features.get("active")))};var e=a.length>2+Number(b(s));const u=e&&0===r.nesting[n]?b(s)?a.length-1:-1:r.nesting[n]-1,d=e&&r.nesting[n]===a.length-1?b(s)?0:-1:r.nesting[n]+1;var e=v([s],this.core.state.features.get("active")),[p,f]=e.reduce((e,t)=>((0<=u&&k.equal(t.nesting,[...r.nesting.slice(0,n),u])||0<=d&&k.equal(t.nesting,[...r.nesting.slice(0,n),d])?e[1]:e[0]).push(t.nesting),e),[[],[]]);this.core.state.points.add("disabled",p),this.core.state.points.remove("disabled",f),this.core.render("points",e),window.requestAnimationFrame(()=>{this.core.state.points.set("hover",[r.nesting]),this.core.state.points.set("active",[r.nesting])}),this.core.addListener("mousemove",c),document.addEventListener("mouseup",e=>{this.core.removeListener("mousemove",c),this.core.removeListener("mousemove","points",l),this.core.removeListener("mouseleave","points",h),this._state.dragging=!1,this.core.state.points.set("active",[]),this._state.features&&(i&&this.config.filter(i)&&this.core.state.points.set("hover",[((null===i||void 0===i?void 0:i.nesting[n])===u?i:r).nesting]),this._state.features=void 0,this.core.features=[...this.core.features.slice(0,r.nesting[0]),i&&k.equal(i.nesting.slice(0,n),r.nesting.slice(0,n))?o(s):s,...this.core.features.slice(r.nesting[0]+1)]),this._render(),this._keypress(e),this._featurehover(t),this._paused&&this.disable()},{once:!0}),this.core.addListener("mousemove","points",l),this.core.addListener("mouseleave","points",h)}_render(){var e=v(null!=(e=this._state.features)?e:this.core.features,this.core.state.features.get("active"));if(this.core.state.features.get("active").some(e=>"number"==typeof e))return this.core.state.points.add("disabled",e.map(e=>e.nesting)),this.core.render("points",e);var t=D(null!=(t=this._state.features)?t:this.core.features,this.core.state.features.get("active")).filter(this.config.filter);this.core.state.points.add("disabled",[...t,...e].map(e=>e.nesting)),this.core.state.points.remove("disabled",e.filter(this.config.filter).map(e=>e.nesting)),this.core.render("points",[...e,...t])}}const P='<path d="M10 8L13.6229 24.8856L17.3004 18.4261L24.6282 17.1796L10 8Z" stroke-linejoin="round"/>',D=(t,e)=>e.reduce((n,e)=>{const a=t[k.plain(e)];return a&&_(a,(s,i)=>{if(!Array.isArray(e)||k.equal(i.slice(0,e.length),e)){const r=y(s,a.type).length;s.slice(1).forEach((e,t)=>{n.push({type:"Point",coordinates:L.normalize(L.middle(e,s[t])),nesting:[...i,r+t],props:a.props})})}}),n},[]),T=(e,t,s,i=!0)=>{if(!e){if(t.every(e=>"number"==typeof e))return i&&1===t.length&&t[0]===s[0]?{active:t,release:()=>[s]}:t.includes(s[0])?{active:t,release:()=>[s[0]]}:{active:[s[0]]};const r=t.map(k.array);return r.some(e=>e[0]===s[0])?r.some(e=>k.equal(e,s))?1<r.length?{active:t,release:()=>[s]}:{active:t,release:()=>[s[0]]}:{active:[s]}:void 0}if(t.every(e=>"number"==typeof e))return t.includes(s[0])?1===t.length?{active:t}:{active:t,release:()=>t.filter(e=>e!==s[0])}:{active:[...t,s[0]]};const r=t.map(k.array);return r.some(e=>e[0]===s[0])?r.some(e=>k.equal(e,s))?1<r.length?{active:t,release:()=>t.filter(e=>!Array.isArray(e)||!k.equal(e,s))}:{active:t}:{active:[...t.filter(e=>"number"==typeof e||!k.equal(e,s,!0)),s]}:void 0};class x extends S{constructor(e){var t;super({types:null!=e&&e.types?Array.isArray(e.types)?e.types:[e.types]:["LineString","Polygon","MultiLineString","MultiPolygon"],create:null==(t=null==e?void 0:e.create)||t,append:null==(t=null==e?void 0:e.append)||t,subtract:null==(t=null==e?void 0:e.subtract)||t,filter:null!=(t=null==e?void 0:e.filter)?t:()=>!0}),this._state={modes:{},reversed:!1},this._stored={active:[]},this._canvasmove=this._canvasmove.bind(this),this._canvasdown=this._canvasdown.bind(this),this._canvasleave=this._canvasleave.bind(this),this._pointenter=this._pointenter.bind(this),this._pointdown=this._pointdown.bind(this),this._keypress=this._keypress.bind(this)}get icon(){return`<g fill="none" transform="translate(-4 -4)">${N(this.config.types)&&q(this.config.types)?E+$:N(this.config.types)?s:r+n}</g>`}start(e){this.config.types.length?(super.start(),this._state.props=null!=e?e:this._state.props,this._stored.active=this.core.state.features.get("active"),this._isolate({})):(this.core.isolate([]),this._stored.cursor=this.core.setCursor(this.cursor("disabled","not-allowed")),this.core.render("points",[]))}enable(){this.disabled&&(super.enable(),this._stored.cursor=this.core.setCursor(this.cursor("default","crosshair")),this._state.event&&this._canvasmove(this._state.event),this.core.addListener("mousemove",this._canvasmove),this.core.addListener("mouseenter","points",this._pointenter),this.core.addListener("mousedown","points",this._pointdown),this.core.addListener("mousedown",this._canvasdown),this.core.addListener("mouseout",this._canvasleave),document.addEventListener("keydown",this._keypress),document.addEventListener("keyup",this._keypress))}disable(){var e,t;this._state.dragging?this.disabled=!0:this.disabled||(super.disable(),null!=(t=(e=this._stored).cursor)&&t.call(e),this._render(),document.removeEventListener("keydown",this._keypress),document.removeEventListener("keyup",this._keypress),this.core.removeListener("mousemove",this._canvasmove),this.core.removeListener("mouseout",this._canvasleave),this.core.removeListener("mousedown",this._canvasdown),this.core.removeListener("mousedown","points",this._pointdown),this.core.removeListener("mouseenter","points",this._pointenter))}finish(){this._save(),this._state={modes:{},props:this._state.props,reversed:!1},super.finish()}delete(e){if(this._state.geometry)return e.map(k.plain).includes(this.core.features.length)?1===e.length?(this.core.state.features.set("active",this._stored.active),this._reset(),this.core.features=this.core.features,!0):void this._reset():void(this._state.feature&&this._reset())}refresh(){var e;if(this._state.geometry){var t=this.core.state.features.get("active");if(t.length&&!t.map(k.plain).includes(k.plain(null!=(e=this._state.nesting)?e:[])))return this._save(t),this._reset(),void this._isolate({})}this._reset(),this._isolate({})}cursor(e,t){return`url(${F(`<g fill="none" stroke="#000">${$}${E}</g>`,`<g fill="#FFF" stroke="#FFF">${E}</g>`,e)}) 8 8, `+t}_keypress(e){this._isolate(e)}_canvasmove(e){if(this._state.event=e,!this._state.geometry){if(this.core.state.features.set("hover",[]),this._state.modes.extend)if(e.points.filter(this.config.filter).find(e=>!this.core.state.points.get(e.nesting).includes("disabled")))return this.core.setCursor(this.cursor("extend","crosshair"));if(this._state.modes.subtract){const s=this.core.state.features.get("disabled").map(k.plain);var t=e.planes.filter(this.config.filter).find(e=>!s.includes(e.nesting[0]));if(this.core.state.points.set("hover",[]),t)return this.core.state.features.set("hover",[t.nesting]),this.core.setCursor(this.cursor("minus","crosshair"))}return this._state.modes.create?this.core.setCursor(this.cursor("default","crosshair")):this._state.modes.append?this.core.setCursor(this.cursor("plus","crosshair")):this.core.setCursor(this.cursor("disabled","not-allowed"))}(t=e.points.filter(this.config.filter).find(e=>!this.core.state.points.get(e.nesting).includes("disabled")))?(this._render(void 0,t),this.core.setCursor(this.cursor("LineString"===this._type(0===t.nesting[t.nesting.length-1]===this._state.reversed)?"line":"polygon","pointer"))):this.core.setCursor(this.cursor("default","crosshair")),t||this._render(e.position)}_canvasdown(e){e.preventDefault(),this._state.dragging=!0;let t=e;const s=e=>{t=e};this.core.addListener("mousemove",s),document.addEventListener("mouseup",()=>{e.preventDefault(),this._state.dragging=!1,this.core.removeListener("mousemove",s),this._state.geometry?this._add(t,this._state.geometry):this._create(e),this.disabled&&(this.disabled=!1,this.disable())},{once:!0})}_pointenter(e){const s=e.points.filter(this.config.filter).find(e=>!this.core.state.points.get(e.nesting).includes("disabled"));if(s){const t=e=>{var t;s&&k.equal(null!=(t=e.points[0].nesting)?t:[],s.nesting)||this.core.state.points.set("hover",[e.points[0].nesting])},i=()=>{this.core.state.points.set("hover",[]),this.core.removeListener("mouseleave","points",i),this.core.removeListener("mousemove","points",t)};this.core.addListener("mouseleave","points",i),this.core.addListener("mousemove","points",t),this.core.state.points.set("hover",[s.nesting])}}_pointdown(e){const t=e.points.filter(this.config.filter).find(e=>!this.core.state.points.get(e.nesting).includes("disabled"));t&&(e.preventDefault(),this.core.state.points.add("active",[t.nesting]),document.addEventListener("mouseup",()=>this.core.state.points.remove("active",[t.nesting]),{once:!0}))}_canvasleave(){this._state.event=void 0,this._state.geometry&&this._render()}_create(e){var t=e.points.filter(this.config.filter).find(e=>!this.core.state.points.get(e.nesting).includes("disabled"));if(t)this._state.modes.extend&&(this.core.state.points.remove("hover",[t.nesting]),this._state.geometry=[],this._state.feature=this.core.getFeatures([t.nesting[0]])[0],this._state.nesting=t.nesting.slice(0,t.nesting.length-1),this.core.state.features.set("active",[this._state.nesting]),this._state.reversed=0===t.nesting[t.nesting.length-1],this.core.isolate(),this._render());else{const s=this.core.state.features.get("active").map(k.plain);if(this._state.modes.subtract){var t=e.planes.filter(this.config.filter).find(e=>s.includes(e.nesting[0]));if(t)return this._state.feature=this.core.getFeatures([t.nesting[0]])[0],this._state.feature?(this._state.nesting="Polygon"===this._state.feature.type?[...t.nesting,this._state.feature.coordinates.length]:[...t.nesting,this._state.feature.coordinates[t.nesting[1]].length],this.core.state.features.set("active",[this._state.nesting]),this._state.geometry=[e.position],this.core.isolate(),void this._render()):void 0}if(this._state.modes.create)t=this.core.features.length,this._state.geometry=[e.position],this._state.nesting=q(this.config.types)?[t]:[t,0],this.core.state.features.set("active",[this._state.nesting]),this.core.isolate(),this._render();else if(this._state.modes.append&&(this._state.feature=this.core.getFeatures(this.core.state.features.get("active"))[0],this._state.feature)){if(b(this._state.feature)&&this.config.types.includes("MultiPolygon"))this._state.nesting=[...this._state.feature.nesting,"Polygon"===this._state.feature.type?1:this._state.feature.coordinates.length,0];else{if(b(this._state.feature)||!this.config.types.includes("MultiLineString"))return;this._state.nesting=[...this._state.feature.nesting,"LineString"===this._state.feature.type?1:this._state.feature.coordinates.length],this._state.modes.extend=!1}this.core.state.features.set("active",[this._state.nesting]),this._state.geometry=[e.position],this._render()}}}_add(e,t){var s=e.points.filter(this.config.filter).find(e=>!this.core.state.points.get(e.nesting).includes("disabled"));if(s)return this._end(s);this._state.geometry=this._state.reversed?[e.position,...t]:[...t,e.position],this._render(),this.core.setCursor(this.cursor("LineString"===this._type()?"line":"polygon","pointer"))}_end(e){var t=this._mutate(this._shape(),e);this.core.state.points.remove("hover",[e.nesting]),this._stored.active.some(e=>Array.isArray(e))||this.core.state.features.set("active",this.core.state.features.get("active").map(k.plain)),this._reset(),this.core.features=[...this.core.features.slice(0,t.nesting[0]),t,...this.core.features.slice(t.nesting[0]+1)]}_shape(e){var t=this._state.feature?y(g(this._state.feature,null!=(t=this._state.nesting)?t:[]),this._state.feature.type):[];return this._state.reversed?[...e?[e]:[],...this._state.geometry||[],...t]:[...t,...this._state.geometry||[],...e?[e]:[]]}_type(e=!0,t=!1){return!this._state.feature||"LineString"===this._state.feature.type&&this._state.modes.extend?t||!N(this.config.types)||(q(this.config.types)||"LineString"===(null==(t=this._state.feature)?void 0:t.type))&&e?"LineString":"Polygon":this._state.feature.type}_mutate(e,t){var s;if(this._state.nesting)return s=e.length<3,t=!t||0===t.nesting[t.nesting.length-1]===this._state.reversed,t=this._type(t,s),u(this._state.feature?{...this._state.feature,type:t}:{nesting:this._state.nesting,type:t,props:this._state.props},k.array(this._state.nesting),m(e,t),[...this.config.types,...this._state.feature?[this._state.feature.type]:[]])}_reset(){this._stored.active=this.core.state.features.get("active"),this.core.render("points",[]),this._state.reversed=!1,this._state.geometry=void 0,this._state.feature=void 0,this._state.nesting=void 0}_render(e,t){var s,i,r,n;this._state.geometry&&this._state.nesting&&(s=this._shape(),i=e?this._state.reversed?[e,...s]:[...s,e]:s,r=(this._state.feature||this._state).props,Number("LineString"===this._type(!0,!1))+s.length<3?this.core.state.points.set("disabled",[[...this._state.nesting,-1],[...this._state.nesting,0],[...this._state.nesting,s.length-1]]):this.core.state.points.set("disabled",[[...this._state.nesting,-1],..."LineString"===this._type(!1,s.length<3)?[[...this._state.nesting,this._state.reversed?s.length-1:0]]:[]]),Number("LineString"===this._type(!0,!1))+i.length<3?(n={nesting:this._state.nesting,type:"LineString",coordinates:i,props:r},this.core.render("features",[...this.core.features,n])):this.core.render("features",[...this.core.features.slice(0,this._state.nesting[0]),this._mutate(i,t),...this.core.features.slice(this._state.nesting[0]+1)]),this.core.render("points",[...e?[{type:"Point",nesting:[...this._state.nesting,-1],coordinates:e,props:r}]:[],{type:"Point",nesting:[...this._state.nesting,0],coordinates:s[0],props:r},{type:"Point",nesting:[...this._state.nesting,s.length-1],coordinates:s[s.length-1],props:r}].filter(this.config.filter)))}_isolate(e){if(!this._state.geometry){var t=this.core.getFeatures(this._stored.active),s=0<t.length&&this._stored.active.every(e=>Array.isArray(e));this._state.modes=Z(this.config,e,t,s);const i=this.core.getFeatures(this._stored.active).filter(e=>"LineString"===e.type||"MultiLineString"===e.type&&q(this.config.types)||N(this.config.types)&&b(e)).map(e=>e.nesting[0]),r=(this.core.state.features.set("active",this.core.state.features.get("active").filter(e=>i.includes(k.plain(e)))),this.core.render("points",v(this.core.features,i).filter(this.config.filter)),this.core.render("features",this.core.features),[]),n=this.core.state.features.get("active");this.core.features.forEach(s=>{s&&n.map(k.plain).includes(s.nesting[0])&&_(s,(e,t)=>{this._state.modes.extend&&!b(s)&&(r.push({type:"Point",nesting:[...t,0],props:s.props,coordinates:e[0]}),r.push({type:"Point",nesting:[...t,e.length-1],props:s.props,coordinates:e[e.length-1]}))})}),this.core.state.points.remove("disabled",r.map(e=>e.nesting)),this.core.state.points.set("active",[]),this.core.render("points",r.filter(this.config.filter)),this.core.isolate(i.map(k.array)),this._state.event&&this._canvasmove({...this._state.event,originalEvent:{...this._state.event.originalEvent,shiftKey:null!=(t=e.shiftKey)&&t,altKey:null!=(s=e.altKey)&&s,ctrlKey:null!=(t=e.ctrlKey)&&t,metaKey:null!=(s=e.metaKey)&&s}})}}_save(e){var t;return this._state.nesting?(t=this._shape(),this._state.geometry=void 0,Number("LineString"===this._type(!0,!1))+t.length<3?(this.core.render("features",this.core.features),this.core.state.features.set("active",null!=e?e:this._stored.active)):(e||this._stored.active.some(e=>Array.isArray(e))||this.core.state.features.set("active",this.core.state.features.get("active").map(k.plain)),void(this.core.features=[...this.core.features.slice(0,this._state.nesting[0]),this._mutate(t,void 0),...this.core.features.slice(this._state.nesting[0]+1)]))):this.core.state.features.set("active",null!=e?e:this._stored.active)}}const E='<circle cx="15.5" cy="15.5" r="1.5" /><path d="M11.75 20C9.5 17.5 9.5 11.5 8 8C11.5 9.5 17.5 9.5 20 11.75C21.6377 13.2239 21.8802 15.8055 21.2345 17.8649C21.1122 18.2552 21.1897 18.6897 21.4789 18.9789L23.5 21L21 23.5L18.9789 21.4789C18.6897 21.1897 18.2552 21.1122 17.8649 21.2345C15.8055 21.8802 13.2239 21.6377 11.75 20Z" stroke-linejoin="round"/>',$='<path d="M8 8L14.375 14.375" stroke-linejoin="round"/>',Z=(s,i,e,t)=>{const r=["append","subtract","create"];var n=r.filter(t=>!!s[t]&&("string"==typeof s[t]?Boolean(i[c(s[t])]):!r.filter(e=>e!==t&&"string"==typeof s[e]&&i[c(s[e])]).length));return{subtract:!!(e.length&&n.includes("subtract")&&N(s.types)&&e.some(e=>b(e))),extend:!(!e.length||!n.includes("append")||!e.some(e=>q(s.types)&&!b(e)||"LineString"===e.type)),append:!(1!==e.length||!n.includes("append")||!t&&n.includes("create")||!e.some(e=>b(e)&&s.types.includes("MultiPolygon")||!b(e)&&s.types.includes("MultiLineString"))),create:!(!n.includes("create")||t&&(n.includes("append")||n.includes("subtract")))}},q=e=>Array.isArray(e)?e.includes("LineString")||e.includes("MultiLineString"):"LineString"===e||"MultiLineString"===e,N=e=>Array.isArray(e)?e.includes("Polygon")||e.includes("MultiPolygon"):"Polygon"===e||"MultiPolygon"===e;class A extends S{get icon(){return`<g fill="none" transform="translate(-4 -4)">${B}</g>`}on(e,t){return this._current=e,this.start(t),!(null!=t&&t.preserve)}off(e){var t;this.finish(),e&&e!==this?null!=(t=this._current)&&t.off(e):null!=(t=this._current)&&t.enable()}start(e){null!=e&&e.preserve?null!=(e=this._current)&&e.disable():(null!=(e=this._current)&&e.off(this),this.core.state.features.set("disabled",[]),this.core.render("points",[]))}}const B='<g stroke-linecap="round"><path d="M11.5 17L10.33 15.5375C9.86747 14.9593 9.02941 14.8529 8.43708 15.2972V15.2972C7.89745 15.7019 7.73245 16.4391 8.04806 17.0352L10.8732 22.3716C11.5664 23.681 12.9267 24.5 14.4083 24.5H16.25H18.9077C20.464 24.5 21.854 23.5264 22.3859 22.0638V22.0638C23.123 20.0369 23.5 17.8967 23.5 15.7399V13C23.5 12.1716 22.8284 11.5 22 11.5V11.5C21.1716 11.5 20.5 12.1716 20.5 13V13"/><path d="M20.5 16.5V10.5C20.5 9.67157 19.8284 9 19 9V9C18.1716 9 17.5 9.67157 17.5 10.5V12"/><path d="M11.5 18V10.5C11.5 9.67157 12.1716 9 13 9V9C13.8284 9 14.5 9.67157 14.5 10.5V15.5"/><path d="M17.5 15.5V9.5C17.5 8.67157 16.8284 8 16 8V8C15.1716 8 14.5 8.67157 14.5 9.5V10"/></g>';class j extends S{get icon(){return`<g fill="none" transform="translate(-4 -4)">${z}</g>`}on(e,t){const r=t||this.core.state.features.get("active");if(r.length&&(null==(t=null==e?void 0:e.delete)||!t.call(e,r))){let i=!1;this.core.features=this.core.features.reduce((e,t)=>{if(!r.some(e=>k.plain(e)===t.nesting[0]))return[...e,t];if(!r.some(e=>e===t.nesting[0])){var s=r.filter(e=>k.plain(e)===t.nesting[0]).reduce((e,t)=>u(e,t),t);if(s)return[...e,s]}return i=!0,e},[]),i&&(this.core.state.features.set("active",[]),this.core.render("points",[]))}return!1}}const z='<g stroke-linecap="round"><path d="M8.5 10.5H23.5"/><path d="M10 10.5L10.929 22.5767C10.9691 23.0977 11.4035 23.5 11.926 23.5H20.074C20.5965 23.5 21.0309 23.0977 21.071 22.5767L22 10.5"/><path d="M14 10.5V9C14 8.44772 14.4477 8 15 8H17C17.5523 8 18 8.44772 18 9V10.5"/><path d="M14 20.5L13.5 14"/><path d="M18 20.5L18.5 14"/></g>',G={move:new C,pen:new x,hand:new A,delete:new j};const I=e=>({position:e.lngLat.toArray(),originalEvent:e.originalEvent});const J=(s,{id:i,layers:e,areaLayer:t})=>{s&&(t&&s.getLayer(i)&&s.removeLayer(i),e.forEach((e,t)=>(null==s?void 0:s.getLayer(i+"-"+(t+1)))&&(null==s?void 0:s.removeLayer(i+"-"+(t+1)))),s.getSource(i))&&s.removeSource(i)},R={points:(e=16)=>({type:"circle",paint:{"circle-radius":e/2,"circle-opacity":0}}),lines:(e=10)=>({type:"line",paint:{"line-width":e,"line-opacity":0},layout:{"line-cap":"round","line-join":"round"}}),planes:()=>({type:"fill",paint:{"fill-opacity":0}})},X={points:{type:"circle",paint:{default:{"circle-stroke-color":["get","color"],"circle-color":"#FFFFFF","circle-radius":2.2,"circle-stroke-width":1.8},disabled:{"circle-radius":1.8,"circle-stroke-width":1,"circle-color":["get","color"]},hover:{"circle-radius":2.6,"circle-color":"#FFFFFF","circle-stroke-width":2},active:{"circle-stroke-color":"#FFFFFF","circle-color":["get","color"]}}},lines:{type:"line",paint:{default:{"line-width":2,"line-color":["get","color"],"line-opacity":.7},disabled:{"line-width":1.2,"line-opacity":.4},hover:{"line-width":2.4,"line-opacity":1},active:{"line-width":2.4,"line-opacity":1}},layout:{"line-cap":"round","line-join":"round"}},planes:{type:"fill",paint:{default:{"fill-color":["get","color"],"fill-opacity":.12},disabled:{"fill-opacity":.03},hover:{"fill-opacity":.16},active:{"fill-opacity":.2}}}},Y={points:"Point",lines:"LineString",planes:"Polygon"};e.AnyTool=S,e.Controller=t,e.DeleteTool=j,e.Geoditor=class{constructor(e){this._loaded=!1,this._requests=[],this._selected=[],this._listeners={load:[],select:[],change:[],render:[],tool:[]},this._core=new K(e.controller,{select:e=>{k.equal(this._selected,e)||(this._selected=e,this._listeners.select.forEach(e=>e(this._selected.map(k.plain))))},change:()=>{var e,t;this._listeners.change.forEach(e=>e(this.data)),this._tool&&null!=(t=null==(e=this._tools[this._tool])?void 0:e.refresh)&&t.call(e)},render:t=>{this._listeners.render.forEach(e=>e(t))}}),this._controller=e.controller,this._tools=null!=(e=null==e?void 0:e.tools)?e:G,Object.values(this._tools).forEach(e=>e.init(this._core)),this._controller.ready(()=>this._init())}on(e,t){this._listeners[e].find(e=>e===t)||(this._listeners[e].push(t),"load"===e&&this._loaded&&t())}off(e,t){this._listeners={...this._listeners,[e]:this._listeners[e].filter(e=>e!==t)}}set data(e){var t;this._core.data=e,this._tool&&null!=(t=null==(e=this._tools[this._tool])?void 0:e.refresh)&&t.call(e)}get data(){return this._core.data}get selected(){return this._selected}set selected(e){var t;k.equal(e,this._selected)||(this._core.state.features.set("active",e),this._tool&&null!=(t=null==(e=this._tools[this._tool])?void 0:e.refresh)&&t.call(e))}get tool(){return this._tool}get tools(){return Object.keys(this._tools).reduce((e,i)=>({...e,[i]:(...t)=>{const s=this._tool&&this._tool!==i?this._tools[this._tool]:void 0;var e=()=>{var e;!1!==(null==(e=this._tools[i])?void 0:e.on(s,...t))&&(this._tool=i,this._listeners.tool.filter(e=>e(i)))};return this._loaded?e():this._requests.push(e),()=>{this._tools[i].off()}}}),{off:()=>{this._tool&&this._tools[this._tool].off(),this._tool=void 0,this._listeners.tool.filter(e=>e()),this._core.reset()}})}icon(e,t,s){{var[e,t=1,s]=[null==(e=this._tools[e])?void 0:e.icon,t,s];if(!e)return null;const i=w(`<g stroke-width="${t}">${e}</g>`,24,s);return{toHTML:()=>i,toBase64:()=>"data:image/svg+xml;base64,"+btoa(i)}}}remove(){var e;this._tool&&null!=(e=this._tools[this._tool])&&e.finish(),this._controller.remove(),this._core.remove()}_init(){this._loaded=!0,this._core.init(),this._requests.forEach(e=>e()),this._requests=[],this._listeners.load.forEach(e=>e())}},e.HandTool=A,e.MapboxController=class extends t{constructor(...e){const[t,s,i]="number"==typeof e[0]||"string"==typeof e[0]?[e[0],e[1],e[2]]:[void 0,e[0],e[1]],r=(super({points:`@@map-editor-${null!=t?t:""}-points`,lines:`@@map-editor-${null!=t?t:""}-lines`,planes:`@@map-editor-${null!=t?t:""}-planes`}),this._features={},this._requested={},this._states={},this._subscriptions=[],this._hovered={},this.addListener=this.addListener.bind(this),this.removeListener=this.removeListener.bind(this),this.setCursor=this.setCursor.bind(this),this.setState=this.setState.bind(this),this.render=this.render.bind(this),this._options=i,this._fillmove=this._fillmove.bind(this),this._fillleave=this._fillleave.bind(this),this._linemove=this._linemove.bind(this),this._lineleave=this._lineleave.bind(this),this._pointmove=this._pointmove.bind(this),this._pointleave=this._pointleave.bind(this),this._render=this._render.bind(this),()=>{var e;this._map=s,this._initSources(this._options),this._map.on("mousemove",this.layerNames.planes,this._fillmove),this._map.on("mousedown",this.layerNames.planes,this._fillmove),this._map.on("mouseleave",this.layerNames.planes,this._fillleave),this._map.on("mousemove",this.layerNames.lines,this._linemove),this._map.on("mousedown",this.layerNames.lines,this._linemove),this._map.on("mouseleave",this.layerNames.lines,this._lineleave),this._map.on("mousemove",this.layerNames.points,this._pointmove),this._map.on("mousedown",this.layerNames.points,this._pointmove),this._map.on("mouseleave",this.layerNames.points,this._pointleave),this._render(),null!=(e=this._ready)&&e.call(this)});s.isStyleLoaded()?r():s.on("load",()=>r())}ready(e){if(this._map)return e();this._ready=e}addListener(...e){var t,s,i;"function"==typeof e[1]?([t,s,i]=e,this._listenmap(t,s,i)):([t,s,i]=e,this._listenlayer(t,s,i))}removeListener(...e){var t,s;"function"==typeof e[1]?([t,s]=e,this._unsubscribe({name:t,callback:s})):([t,s,e]=e,this._unsubscribe({name:t,layer:s,callback:e}))}setCursor(e){if(this._map){const t=this._map.getCanvas().style.cursor;return t!==e&&(this._map.getCanvas().style.cursor=e),()=>{this._map&&this._map.getCanvas().style.cursor!==t&&(this._map.getCanvas().style.cursor=t)}}}setState(s,e,t,i){if("points"===s)return this._setState(s,e.map(e=>e.map(e=>e+1).join(".")+"."),t,i);this._setState(s,e.reduce((e,t)=>{const i=t.map(e=>e+1).join(".")+".";return[...e,i,...(null!=(t=this._features[s])?t:[]).reduce((e,t)=>{var s;return 0!==(null==(s=t.id)?void 0:s.toString().indexOf(i))?e:[...e,t.id.toString()]},[])]},[]),t,i)}render(e,t){if("points"===e)return this._toFeatures("points",t);this._toFeatures("planes",t.reduce((e,s)=>{switch(s.type){case"Polygon":return[...e,s];case"MultiPolygon":return[...e,...s.coordinates.map((e,t)=>({...s,type:"Polygon",coordinates:e,nesting:[...s.nesting,t]}))];default:return e}},[])),this._toFeatures("lines",t.reduce((e,s)=>{const i=[];return _(s,(e,t)=>{i.push({type:"LineString",coordinates:e,nesting:[...t],props:s.props})}),[...e,...i]},[]))}get renderer(){return this._map}remove(){var e;null!=(e=this._map)&&e.off("mousemove",this.layerNames.planes,this._fillmove),null!=(e=this._map)&&e.off("mousedown",this.layerNames.planes,this._fillmove),null!=(e=this._map)&&e.off("mouseleave",this.layerNames.planes,this._fillleave),null!=(e=this._map)&&e.off("mousemove",this.layerNames.lines,this._linemove),null!=(e=this._map)&&e.off("mousedown",this.layerNames.lines,this._linemove),null!=(e=this._map)&&e.off("mouseleave",this.layerNames.lines,this._lineleave),null!=(e=this._map)&&e.off("mousemove",this.layerNames.points,this._pointmove),null!=(e=this._map)&&e.off("mousedown",this.layerNames.points,this._pointmove),null!=(e=this._map)&&e.off("mouseleave",this.layerNames.points,this._pointleave),null!=(e=this._removeSources)&&e.call(this),this._map=void 0}lock(){var e;if(this._locked)return()=>{};this._locked=!0;const t=null==(e=this._map)?void 0:e.dragPan.isEnabled(),s=null==(e=this._map)?void 0:e.dragRotate.isEnabled(),i=null==(e=this._map)?void 0:e.boxZoom.isEnabled(),r=null==(e=this._map)?void 0:e.doubleClickZoom.isEnabled();return t&&null!=(e=this._map)&&e.dragPan.disable(),s&&null!=(e=this._map)&&e.dragRotate.disable(),i&&null!=(e=this._map)&&e.boxZoom.disable(),r&&null!=(e=this._map)&&e.doubleClickZoom.disable(),()=>{var e;t&&null!=(e=this._map)&&e.dragPan.enable(),s&&null!=(e=this._map)&&e.dragRotate.enable(),i&&null!=(e=this._map)&&e.boxZoom.enable(),r&&null!=(e=this._map)&&e.doubleClickZoom.enable(),this._locked=!1}}_mapHandler(){var e;return{preventDefault:()=>{window.requestAnimationFrame(this.lock())},points:[...null!=(e=this._hovered.points)?e:[]],lines:[...null!=(e=this._hovered.lines)?e:[]],planes:[...null!=(e=this._hovered.planes)?e:[]]}}_toFeatures(t,e){this._features[t]=e.map(e=>({id:e.nesting.map(e=>e+1).join(".")+".",type:"Feature",geometry:{type:Y[t],coordinates:e.coordinates},properties:{...e.props,nesting:JSON.stringify(e.nesting)}}));const s=null!=(e=null==(e=this._features[t])?void 0:e.map(e=>e.id))?e:[];this._hovered[t]=null==(e=this._hovered[t])?void 0:e.filter(e=>s.includes(e.nesting.map(e=>e+1).join(".")+".")),this._requested[t]=!0}_initSources(i){var e;const r=(null!=(e=null==i?void 0:i.layerStyles)?e:(e=null!=(e=null==i?void 0:i.config)?e:X,Object.values(e).reduce((e,s)=>{var t;return s?(t=Object.keys(s.paint.default),[...e,{type:s.type,paint:t.reduce((e,t)=>{return{...e,[t]:["case",["all",["boolean",["feature-state","hover"],!1],["boolean",["feature-state","active"],!1]],(null==(e=s.paint.active)?void 0:e[t])||(null==(e=s.paint.hover)?void 0:e[t])||s.paint.default[t],["boolean",["feature-state","active"],!1],(null==(e=s.paint.active)?void 0:e[t])||s.paint.default[t],["all",["boolean",["feature-state","hover"],!1],["boolean",["feature-state","disabled"],!1]],s.paint.default[t],["boolean",["feature-state","hover"],!1],(null==(e=s.paint.hover)?void 0:e[t])||s.paint.default[t],["boolean",["feature-state","disabled"],!1],(null==(e=s.paint.disabled)?void 0:e[t])||s.paint.default[t],s.paint.default[t]]}},{}),...s.layout?{layout:s.layout}:{}}]):e},[]))).reduce((e,t)=>{switch(t.type){case"line":e.lines.push(t);break;case"fill":e.planes.push(t);break;default:e.points.push(t)}return e},{points:[],lines:[],planes:[]}),t=[...Object.keys(this.layerNames).reduce((e,t)=>{var s=null==(s=null==i?void 0:i.area)?void 0:s[t];return[...e,{id:this.layerNames[t],layers:r[t],areaLayer:!1!==s?R[t](s):void 0}]},[])];t.forEach(e=>{var s,i,t;[s,{id:i,layers:e,areaLayer:t}]=[this._map,e],s&&(s.getSource(i)&&J(s,{id:i,layers:e,areaLayer:t}),s.addSource(i,{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.forEach((e,t)=>null==s?void 0:s.addLayer({...e,id:i+"-"+(t+1),source:i})),t)&&s.addLayer({...t,source:i,id:i})}),this._removeSources=()=>t.forEach(e=>J(this._map,e))}_subscribe(t){var e=this._subscriptions.findIndex(e=>e.name===t.name&&e.layer===t.layer&&e.callback===t.callback);0<=e?(this._subscriptions[e].off(),this._subscriptions[e]=t):this._subscriptions.push(t)}_unsubscribe(t){var e=this._subscriptions.findIndex(e=>e.name===t.name&&e.layer===t.layer&&e.callback===t.callback);0<=e&&(this._subscriptions[e].off(),this._subscriptions=[...this._subscriptions.slice(0,e),...this._subscriptions.slice(e+1)])}_listenmap(t,s,e){const i=e=>{s({...I(e),...this._mapHandler()})};null!=e&&e.once?null!=(e=this._map)&&e.once(t,i):(null!=(e=this._map)&&e.on(t,i),this._subscribe({callback:s,name:t,off:()=>{var e;return null==(e=this._map)?void 0:e.off(t,i)}}))}_listenlayer(t,s,i){var e;const r=e=>{i({...I(e),layer:s,...this._mapHandler()})};if("mouseleave"===t||"mouseover"===t)return this._subscribe({callback:i,name:t,layer:s,off:function(e,t,s){let i;const r=e=>{i=e.point},n=e=>{e.point.x===(null===i||void 0===i?void 0:i.x)&&e.point.y===i.y||s(e)};return null!=e&&e.on("mousemove",t,r),null!=e&&e.on("mousemove",n),()=>{null!=e&&e.off("mousemove",n),null!=e&&e.off("mousemove",t,r)}}(this._map,this.layerNames[s],r)});null!=(e=this._map)&&e.on(t,this.layerNames[s],r),this._subscribe({name:t,layer:s,callback:i,off:()=>{var e;return null==(e=this._map)?void 0:e.off(t,this.layerNames[s],r)}})}_render(){["points","lines","planes"].forEach(i=>{var e;if(this._requested[i]){const r=e=>({...e,id:e.id.split(".").join("0")});var t=(null!=(t=this._features[i])?t:[]).reduce((e,t)=>{var s;return null!=(s=null==(s=this._states[i])?void 0:s.active)&&s.includes(t.id)?{...e,active:[...e.active,r(t)]}:null!=(s=null==(s=this._states[i])?void 0:s.hover)&&s.includes(t.id)?{...e,hover:[...e.hover,r(t)]}:null!=(s=null==(s=this._states[i])?void 0:s.disabled)&&s.includes(t.id)?{...e,disabled:[...e.disabled,r(t)]}:{...e,default:[...e.default,r(t)]}},{disabled:[],default:[],hover:[],active:[]});null!=(e=null==(e=this._map)?void 0:e.getSource(this.layerNames[i]))&&e.setData({type:"FeatureCollection",features:[...t.disabled,...t.default,...t.hover,...t.active]}),this._requested[i]=!1}}),this._map&&window.requestAnimationFrame(this._render)}_setState(s,e,i,r){let n=!1;e.forEach(t=>{var e;t&&(r!==(null==(e=null==(e=this._states[s])?void 0:e[i])?void 0:e.includes(t))&&(this._states[s]={...this._states[s],[i]:r?[...null!=(e=null==(e=this._states[s])?void 0:e[i])?e:[],t]:(null!=(e=null==(e=this._states[s])?void 0:e[i])?e:[]).filter(e=>e!==t)},n=!0),null!=(e=this._map))&&e.setFeatureState({id:t.split(".").join("0"),source:this.layerNames[s]},{[i]:r})}),n&&(this._requested[s]=!0)}_fillmove(e){this._hovered.planes=(e.features||[]).map(e=>{const{nesting:t,...s}=e.properties;return{type:"Polygon",coordinates:e.geometry.coordinates,nesting:JSON.parse(t),props:s}})}_fillleave(){this._hovered.planes=[]}_linemove(e){this._hovered.lines=(e.features||[]).map(e=>{const{nesting:t,...s}=e.properties;return{type:"LineString",coordinates:e.geometry.coordinates,nesting:JSON.parse(t),props:s}})}_lineleave(){this._hovered.lines=[]}_pointmove(e){var t,s;this._hovered.points=(t=null!=(t=e.features)?t:[],s=e.lngLat.toArray(),[...t].sort((e,t)=>L.closest(e.geometry.coordinates,s)>=L.closest(t.geometry.coordinates,s)?1:-1).map(e=>{const{nesting:t,...s}=e.properties;return{type:"Point",coordinates:e.geometry.coordinates,nesting:JSON.parse(t),props:s}}))}_pointleave(){this._hovered.points=[]}},e.MoveTool=C,e.PenTool=x,Object.defineProperty(e,"__esModule",{value:!0})});
